<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CRUD Funcionários — Painel (Atualizado)</title>
    <style>
        /* ===========================
       CSS ORIGINAL (preservado)
       =========================== */
        :root {
            --bg: #071028;
            --card: #0b1220;
            --accent: #7c3aed;
            --muted: #94a3b8;
            --glass: rgba(255, 255, 255, 0.03);
            --white: #e6eef8;
            --scroll-w: 10px;
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(180deg, #071028 0%, #07121e 100%);
            color: var(--white);
            padding: 28px
        }

        .container {
            max-width: 1100px;
            margin: 0 auto
        }

        .mockup {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(59, 130, 246, 0.06));
            padding: 18px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
            margin-bottom: 22px
        }

        .mockup h2 {
            margin: 0 0 8px 0;
            font-size: 18px
        }

        .preview {
            display: flex;
            gap: 18px;
            align-items: flex-start
        }

        /* aumentei um pouco largura do sidebar para caber botões */
        .sidebar {
            width: 350px;
            background: var(--card);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0
        }

        .main {
            flex: 1;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            padding: 12px;
            border-radius: 10px
        }

        .avatar-sample {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), #06b6d4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700
        }

        .card-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: var(--glass)
        }

        .btn-primary {
            background: var(--accent);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--white);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer
        }

        .btn-danger {
            background: transparent;
            color: #ff8b8b;
            border: 1px solid rgba(255, 107, 107, 0.12);
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 18px 0
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 18px
        }

        .panel {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.03)
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .employee {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
            border: 1px solid rgba(255, 255, 255, 0.02)
        }

        .meta {
            flex: 1
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .actions {
            display: flex;
            gap: 8px
        }

        /* Admin list with vertical scroll and fixed height */
        .admins-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 6px
        }

        .admin-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background: #081227;
            border: 1px solid rgba(255, 255, 255, 0.02)
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff
        }

        /* employees grid wrapper with fixed height + scroll */
        .employees-grid-wrapper {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 6px
        }

        #employeesGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px
        }

        /* management list fixed height + scroll */
        .management-list-wrapper {
            max-height: 360px;
            overflow-y: auto;
            padding-right: 6px
        }

        /* details panel (lado direito) - limitar altura */
        .details-panel {
            max-height: 360px;
            overflow-y: auto;
            padding-right: 6px
        }

        /* modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 60
        }

        .modal {
            width: 740px;
            max-width: 100%;
            background: linear-gradient(180deg, #071428, #081029);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.04)
        }

        .form-row {
            display: flex;
            gap: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            flex: 1
        }

        label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px
        }

        input[type="text"],
        input[type="number"],
        select {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px;
            border-radius: 8px;
            color: var(--white)
        }

        .avatar-preview {
            width: 92px;
            height: 92px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), #06b6d4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px
        }

        .muted-note {
            font-size: 13px;
            color: var(--muted);
            margin-top: 6px
        }

        /* scrollbar visual */
        .admins-list::-webkit-scrollbar,
        .employees-grid-wrapper::-webkit-scrollbar,
        .management-list-wrapper::-webkit-scrollbar,
        .details-panel::-webkit-scrollbar {
            width: var(--scroll-w);
        }

        .admins-list::-webkit-scrollbar-thumb,
        .employees-grid-wrapper::-webkit-scrollbar-thumb,
        .management-list-wrapper::-webkit-scrollbar-thumb,
        .details-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
        }

        @media (max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }

            .preview {
                flex-direction: column
            }

            .sidebar {
                width: 100%
            }
        }

        /* painel pequeno do Super Admin */
        .logged-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04)
        }

        .logged-panel .lbl {
            font-weight: 600
        }

        /* ===========================
       NOVAS CLASSES (substituem
       styles inline no HTML)
       =========================== */

        /* flex row, space-between, center */
        .f-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* flex row, gap N, center */
        .f-row-gap8 {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .f-row-gap12 {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .f-row-gap10 {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* column flex variants */
        .col-end {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .col-center-gap10 {
            width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* simple flex helper */
        .flex-1 {
            flex: 1;
        }

        /* font weight helpers */
        .fw-700 {
            font-weight: 700;
        }

        .fw-600 {
            font-weight: 600;
        }

        /* margin helpers */
        .mb-12 {
            margin-bottom: 12px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-12 {
            margin-top: 12px;
        }

        .mt-6 {
            margin-top: 6px;
        }

        /* toolbar / header helpers */
        .toolbar-title {
            font-size: 20px;
            font-weight: 700;
        }

        .toolbar-controls {
            display: flex;
            gap: 10px;
        }

        /* modal-specific helpers */
        .modal-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .modal-img-col {
            width: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .modal-footer-left {
            display: flex;
            gap: 8px;
        }

        /* small paddings and button tweaks */
        .btn-small-pad {
            padding: 6px 8px;
        }

        /* utility to hide (used nos botões 'Apagar' inicialmente) */
        .hide {
            display: none;
        }

        /* inline center row used inside card markup */
        .card-row-inline {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* fallback for elements that had inline background + radius inside static markup */
        .card-empty-state {
            grid-column: 1/-1;
            padding: 18px;
            background: rgba(255, 255, 255, 0.01);
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="mockup">
            <h2>Visualização (mockup) — CRUD de Funcionários</h2>

            <div class="preview">
                <div class="sidebar" id="sidebarAdmins">
                    <div class="f-between">
                        <div class="f-row-gap8">
                            <div class="avatar-sample" id="superAvatar">EB</div>
                            <div>
                                <div class="fw-700">Edson Bernardo — Super Admin</div>
                                <div class="small">Administrador principal</div>
                            </div>
                        </div>

                        <div class="col-end">
                            <div class="logged-panel">
                                <div class="lbl">Logado como</div>
                                <div class="fw-700">EB</div>
                                <button id="btnChangePwd" class="btn-ghost btn-small-pad">Alterar senha</button>
                            </div>

                            <button id="btnAddAdmin" class="btn-primary">Adicionar</button>
                        </div>
                    </div>

                    <div class="mt-10 fw-700">Administradores</div>
                    <div class="admins-list" id="adminsList"><!-- administradores por JS --></div>
                </div>

                <div class="main">
                    <div class="f-between mb-12">
                        <div class="fw-700">Lista de Funcionários</div>
                        <div class="small">Exibição — Cartões com ações</div>
                    </div>

                    <div class="employees-grid-wrapper">
                        <div id="employeesGrid"><!-- grid preenchido por JS --></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMPLEMENTAÇÃO REAL -->
        <div class="toolbar">
            <div class="toolbar-title">Gestão de Funcionários</div>
            <div class="toolbar-controls">
                <button id="btnAddEmployee" class="btn-primary">+ Novo Funcionário</button>
                <button id="btnClear" class="btn-ghost">Limpar armazenamento</button>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <div class="fw-700 mb-10">Lista detalhada</div>
                <div class="management-list-wrapper">
                    <div class="list" id="managementList"><!-- detalhes por JS --></div>
                </div>
            </div>

            <div class="panel details-panel">
                <div class="fw-700 mb-10">Detalhes / Ações</div>
                <div class="small">Clique em um funcionário para ver/editar os detalhes. Você pode editar ou apagar a
                    partir do modal.</div>

                <div class="mt-12">
                    <div class="fw-600">Contagem</div>
                    <div id="count" class="small mt-6">0 funcionários</div>
                </div>

                <div class="mt-10 muted-note">Observação: apenas o Super Admin pode editar e apagar registros.</div>
            </div>
        </div>
    </div>

    <!-- MODAL ADMIN -->
    <div id="modalAdmin" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <h3 id="adminTitle">Novo Administrador</h3>

            <div class="modal-row">
                <div class="flex-1">

                    <div class="field">
                        <label>Nome</label>
                        <input id="adminNome" type="text" placeholder="Nome completo">
                    </div>

                    <div class="field">
                        <label>BI</label>
                        <input id="adminBI" type="text" placeholder="Número de BI">
                    </div>

                    <div class="field">
                        <label>Email</label>
                        <input id="adminEmail" type="email" placeholder="Email">
                    </div>

                    <div class="field">
                        <label>Telefone</label>
                        <input id="adminTelefone" type="text" placeholder="Telefone">
                    </div>

                    <div class="field">
                        <label>Cargo</label>
                        <input id="adminCargo" type="text" placeholder="Ex.: Administrador">
                    </div>

                    <div class="field">
                        <label>Salário (AOA)</label>
                        <input id="adminSalario" type="number" min="0" step="0.01" placeholder="Ex.: 120000">
                    </div>

                    <div class="muted-note">Validação: nomes não podem conter caracteres especiais repetidos (ex.: @@@).
                        Imagem ≤ 1.5MB.
                    </div>
                </div>

                <div class="modal-img-col">
                    <div id="adminImgPreview" class="avatar-preview">+ </div>
                    <input id="adminImgInput" type="file" accept="image/*">
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="adminDeleteBtn" class="btn-danger hide">Apagar</button>
                    <button id="adminCancelBtn" class="btn-ghost">Cancelar</button>
                </div>
                <div>
                    <button id="adminSaveBtn" class="btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FUNCIONÁRIO -->
    <div id="modalEmployee" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <h3 id="employeeTitle">Novo Funcionário</h3>

            <div class="modal-row">
                <div class="flex-1">
                    <div class="field">
                        <label>Nome</label>
                        <input id="empNome" type="text" placeholder="Nome completo">
                    </div>

                    <div class="field">
                        <label>BI</label>
                        <input id="empBI" type="text" placeholder="Número de BI">
                    </div>

                    <div class="field">
                        <label>Email</label>
                        <input id="empEmail" type="email" placeholder="Email">
                    </div>

                    <div class="field">
                        <label>Telefone</label>
                        <input id="empTelefone" type="text" placeholder="Telefone">
                    </div>

                    <div class="field">
                        <label>Cargo</label>
                        <input id="empCargo" type="text" placeholder="Ex.: Desenvolvedor">
                    </div>

                    <div class="field">
                        <label>Salário (AOA)</label>
                        <input id="empSalario" type="number" min="0" step="0.01" placeholder="Ex.: 80000">
                    </div>

                    <div class="muted-note">Validação: nomes não podem conter caracteres especiais repetidos (ex.: @@@).
                        Imagem ≤ 1.5MB.</div>
                </div>

                <div class="modal-img-col">
                    <div id="empImgPreview" class="avatar-preview">+</div>
                    <input id="empImgInput" type="file" accept="image/*">
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-footer-left">
                    <button id="empDeleteBtn" class="btn-danger hide">Apagar</button>
                    <button id="empCancelBtn" class="btn-ghost">Cancelar</button>
                </div>
                <div>
                    <button id="empSaveBtn" class="btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==============
       SCRIPT (INALTERADO)
       ============== -->
    <script>
        // keys
        const adminsKey = 'admins_v1';
        const empsKey = 'funcionarios_v1';
        const pwdKey = 'superadmin_pwd';

        // fixed current user: Super Admin
        const currentUser = { role: 'superadmin', name: 'EB20' };

        let admins = JSON.parse(localStorage.getItem(adminsKey) || '[]');
        let employees = JSON.parse(localStorage.getItem(empsKey) || '[]');

        // elements
        const adminsListEl = document.getElementById('adminsList');
        const employeesGrid = document.getElementById('employeesGrid');
        const managementList = document.getElementById('managementList');
        const countEl = document.getElementById('count');
        const superAvatar = document.getElementById('superAvatar');

        // logged panel
        document.getElementById('btnChangePwd').addEventListener('click', () => {
            const cur = localStorage.getItem(pwdKey) || '';
            const newPwd = prompt('Defina nova senha (fictícia) para Super Admin:', cur);
            if (newPwd !== null) { localStorage.setItem(pwdKey, newPwd); alert('Senha atualizada (fictícia).'); }
        });

        // show avatar initials for superadmin
        superAvatar.textContent = initials(currentUser.name);

        // action buttons
        document.getElementById('btnAddAdmin').addEventListener('click', openModalAdminNew);
        document.getElementById('btnAddEmployee').addEventListener('click', openModalEmpNew);
        document.getElementById('btnClear').addEventListener('click', () => {
            if (confirm('Limpar todos os dados (administradores e funcionários)?')) {
                admins = []; employees = []; saveAll(); renderAll();
            }
        });

        // modal admin
        const modalAdmin = document.getElementById('modalAdmin');
        const adminTitle = document.getElementById('adminTitle');
        const adminNome = document.getElementById('adminNome');
        const adminCargo = document.getElementById('adminCargo');
        const adminSalario = document.getElementById('adminSalario');
        const adminImgPreview = document.getElementById('adminImgPreview');
        const adminImgInput = document.getElementById('adminImgInput');
        const adminSaveBtn = document.getElementById('adminSaveBtn');
        const adminCancelBtn = document.getElementById('adminCancelBtn');
        const adminDeleteBtn = document.getElementById('adminDeleteBtn');
        let editingAdminIndex = null;

        // admin modal fields
        const adminBI = document.getElementById('adminBI');
        const adminEmail = document.getElementById('adminEmail');
        const adminTelefone = document.getElementById('adminTelefone');

        // employee modal fields
        const empBI = document.getElementById('empBI');
        const empEmail = document.getElementById('empEmail');
        const empTelefone = document.getElementById('empTelefone');


        // modal employee
        const modalEmp = document.getElementById('modalEmployee');
        const employeeTitle = document.getElementById('employeeTitle');
        const empNome = document.getElementById('empNome');
        const empCargo = document.getElementById('empCargo');
        const empSalario = document.getElementById('empSalario');
        const empImgPreview = document.getElementById('empImgPreview');
        const empImgInput = document.getElementById('empImgInput');
        const empSaveBtn = document.getElementById('empSaveBtn');
        const empCancelBtn = document.getElementById('empCancelBtn');
        const empDeleteBtn = document.getElementById('empDeleteBtn');
        let editingEmpIndex = null;

        // validações
        function hasRepeatedSpecials(s) {
            // encontra qualquer caracter não alfanumérico (exceto espaço) repetido 3 ou mais vezes
            return /([^\w\s])\1{2,}/.test(s);
        }
        function validateImageFile(file) {
            if (!file) return true;
            const limit = 1.5 * 1024 * 1024; // 1.5 MB
            if (file.size > limit) {
                alert('Imagem muito grande. Limite: 1.5 MB.');
                return false;
            }
            return true;
        }

        function toDataURL(file, cb) {
            const reader = new FileReader();
            reader.onload = () => cb(reader.result);
            reader.readAsDataURL(file);
        }

        // admin image input
        adminImgInput.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            if (!validateImageFile(f)) { adminImgInput.value = ''; return; }
            toDataURL(f, src => { adminImgPreview.innerHTML = '<img src="' + src + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px">'; adminImgPreview.dataset.src = src; });
        });

        // emp image input
        empImgInput.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            if (!validateImageFile(f)) { empImgInput.value = ''; return; }
            toDataURL(f, src => { empImgPreview.innerHTML = '<img src="' + src + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px">'; empImgPreview.dataset.src = src; });
        });

        // admin save
        adminSaveBtn.addEventListener('click', () => {
            // ler campos (inclui BI, email, telefone)
            const nome = adminNome.value.trim();
            const bi = adminBI.value.trim();
            const email = adminEmail.value.trim();
            const telefone = adminTelefone.value.trim();

            // validações
            if (!nome) { alert('Preencha o nome.'); return; }
            if (hasRepeatedSpecials(nome)) { alert('Nome inválido: caracteres especiais repetidos detectados.'); return; }

            const cargo = adminCargo.value.trim() || 'Administrador';
            const salario = Number(adminSalario.value) || 0;
            const image = adminImgPreview.dataset.src || null;

            if (editingAdminIndex === null) {
                // criar novo
                const id = Date.now() + Math.floor(Math.random() * 999);
                const obj = { nome, bi, email, telefone, cargo, salario, image, role: 'admin', id };
                admins.push(obj);
                // também inserir na lista geral de employees (admin como funcionário)
                employees.push({ ...obj });
            } else {
                // atualizar existente
                const old = admins[editingAdminIndex];
                admins[editingAdminIndex] = { ...old, nome, bi, email, telefone, cargo, salario, image };
                // atualizar também na lista de employees, se existir
                const idxE = employees.findIndex(e => e.id === old.id);
                if (idxE !== -1) {
                    employees[idxE] = { ...employees[idxE], nome, bi, email, telefone, cargo, salario, image, role: 'admin' };
                }
            }

            saveAll();
            renderAll();
            closeModalAdmin();
        });



        adminCancelBtn.addEventListener('click', closeModalAdmin);
        adminDeleteBtn.addEventListener('click', () => {
            if (editingAdminIndex === null) return;
            if (!confirm('Apagar este administrador?')) return;
            const id = admins[editingAdminIndex].id;
            admins.splice(editingAdminIndex, 1);
            employees = employees.filter(e => e.id !== id);
            saveAll(); renderAll(); closeModalAdmin();
        });

        function openModalAdminNew() {
            editingAdminIndex = null;
            adminTitle.textContent = 'Novo Administrador';
            adminDeleteBtn.style.display = 'none';
            clearAdminForm();
            showModal(modalAdmin);
        }
        function openModalAdminEdit(idx) {
            editingAdminIndex = idx;
            const a = admins[idx];
            adminTitle.textContent = 'Editar Administrador';
            adminDeleteBtn.style.display = 'inline-block';
            adminNome.value = a.nome;
            adminCargo.value = a.cargo;
            adminSalario.value = a.salario;
            if (a.image) { adminImgPreview.innerHTML = '<img src="' + a.image + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px">'; adminImgPreview.dataset.src = a.image } else { adminImgPreview.innerHTML = '+'; delete adminImgPreview.dataset.src; }
            showModal(modalAdmin);
        }
        function clearAdminForm() {
            adminNome.value = '';
            adminCargo.value = '';
            adminSalario.value = '';
            adminBI.value = '';
            adminEmail.value = '';
            adminTelefone.value = '';
            adminImgPreview.innerHTML = '+';
            delete adminImgPreview.dataset.src;
            adminImgInput.value = '';
        }
        function closeModalAdmin() { modalAdmin.style.display = 'none'; }

        // employee save
        empSaveBtn.addEventListener('click', () => {
            // ler campos (inclui BI, email, telefone)
            const nome = empNome.value.trim();
            const bi = empBI.value.trim();
            const email = empEmail.value.trim();
            const telefone = empTelefone.value.trim();

            // validações
            if (!nome) { alert('Preencha o nome.'); return; }
            if (hasRepeatedSpecials(nome)) { alert('Nome inválido: caracteres especiais repetidos detectados.'); return; }

            const cargo = empCargo.value.trim() || 'Funcionário';
            const salario = Number(empSalario.value) || 0;
            const image = empImgPreview.dataset.src || null;

            if (editingEmpIndex === null) {
                // criar novo funcionário
                const id = Date.now() + Math.floor(Math.random() * 999);
                const obj = { nome, bi, email, telefone, cargo, salario, image, role: 'employee', id };
                employees.push(obj);
            } else {
                // atualizar existente
                const old = employees[editingEmpIndex];
                employees[editingEmpIndex] = { ...old, nome, bi, email, telefone, cargo, salario, image };
                // se esse employee também for admin, atualiza admin correspondente
                const ai = admins.findIndex(a => a.id === old.id);
                if (ai !== -1) {
                    admins[ai] = { ...admins[ai], nome, bi, email, telefone, cargo, salario, image, role: 'admin' };
                }
            }

            saveAll();
            renderAll();
            closeModalEmp();
        });


        empCancelBtn.addEventListener('click', closeModalEmp);
        empDeleteBtn.addEventListener('click', () => {
            if (editingEmpIndex === null) return;
            if (!confirm('Apagar este funcionário?')) return;
            const id = employees[editingEmpIndex].id;
            employees.splice(editingEmpIndex, 1);
            admins = admins.filter(a => a.id !== id);
            saveAll(); renderAll(); closeModalEmp();
        });

        function openModalEmpNew() {
            editingEmpIndex = null;
            employeeTitle.textContent = 'Novo Funcionário';
            empDeleteBtn.style.display = 'none';
            clearEmpForm();
            showModal(modalEmp);
        }
        function openModalEmpEdit(idx) {
            editingEmpIndex = idx;
            const e = employees[idx];
            employeeTitle.textContent = 'Editar Funcionário';
            empDeleteBtn.style.display = 'inline-block';
            empNome.value = e.nome;
            empCargo.value = e.cargo;
            empSalario.value = e.salario;
            if (e.image) { empImgPreview.innerHTML = '<img src="' + e.image + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px">'; empImgPreview.dataset.src = e.image } else { empImgPreview.innerHTML = '+'; delete empImgPreview.dataset.src; }
            showModal(modalEmp);
        }

        function clearEmpForm() {
            empNome.value = '';
            empCargo.value = '';
            empSalario.value = '';
            empBI.value = '';
            empEmail.value = '';
            empTelefone.value = '';
            empImgPreview.innerHTML = '+';
            delete empImgPreview.dataset.src;
            empImgInput.value = '';
        }

        function closeModalEmp() { modalEmp.style.display = 'none'; }

        function showModal(modalEl) { modalEl.style.display = 'flex'; modalEl.querySelector('.modal').style.transform = 'translateY(0)'; }

        // render
        function formatCurrency(v) { return Number(v || 0).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function initials(name) { return (name.split(' ').map(x => x[0]).slice(0, 2).join('') || '??').toUpperCase(); }

        function colorFromString(s) {
            // gera uma cor HSL baseada no hash do nome
            let h = 0;
            for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) % 360;
            return `hsl(${h} 70% 45%)`;
        }


        // ----- Substitua a função renderAll inteira por esta -----
        function renderAll() {
            // admins sidebar
            adminsListEl.innerHTML = '';
            if (admins.length === 0) {
                adminsListEl.innerHTML = '<div class="small">Nenhum administrador cadastrado.</div>';
            } else {
                admins.forEach((a, idx) => {
                    const div = document.createElement('div');
                    div.className = 'admin-card';
                    // se não tem imagem, deixamos inline style para background (mantendo o que já fazia)
                    const bg = a.image ? '' : `style="background:${colorFromString(a.nome)}"`;
                    div.innerHTML = `
                <div class="avatar" ${bg}>
                    ${a.image
                            ? `<img src="${a.image}" style="width:100%;height:100%;object-fit:cover">`
                            : initials(a.nome)}
                </div>
                <div style="flex:1">
                    <div style="font-weight:700">${a.nome}</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    ${currentUser.role === 'superadmin'
                            ? `<button data-admin-edit="${idx}" class="btn-ghost">Editar</button>
                           <button data-admin-delete="${idx}" class="btn-danger">Apagar</button>`
                            : ''}
                </div>
            `;
                    adminsListEl.appendChild(div);
                });
            }

            // employees grid (includes admins)
            // employees grid (visualização Mocha Pro)
            employeesGrid.innerHTML = '';
            if (employees.length === 0) {
                employeesGrid.innerHTML = '<div class="card-empty-state">Nenhum funcionário cadastrado.</div>';
            } else {
                employees.forEach(emp => {
                    const card = document.createElement('div');
                    card.className = 'employee-card';
                    card.style.padding = '12px';
                    card.style.background = 'rgba(255,255,255,0.02)';
                    card.style.borderRadius = '10px';
                    card.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px">
                <div style="width:44px;height:44px;border-radius:8px;overflow:hidden;background:#081220;flex-shrink:0">
                    ${emp.image
                            ? `<img src="${emp.image}" style="width:100%;height:100%;object-fit:cover">`
                            : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700; background:${colorFromString(emp.nome)}">${initials(emp.nome)}</div>`}
                </div>
                <div style="flex:1; display:flex; flex-direction: column; gap:4px">
                    <div style="font-weight:700">${emp.nome}</div>
                    <div class="small">Cargo: ${emp.cargo}</div>
                    <div class="small">Salário: ${formatCurrency(emp.salario)} Kz</div>
                    ${emp.bi ? `<div class="small">BI: ${emp.bi}</div>` : ''}
                    ${emp.email ? `<div class="small">Email: ${emp.email}</div>` : ''}
                    ${emp.telefone ? `<div class="small">Telefone: ${emp.telefone}</div>` : ''}
                </div>
            </div>
        `;
                    employeesGrid.appendChild(card);
                });
            }


            // management list (lado esquerdo / detalhe)
            managementList.innerHTML = '';
            if (employees.length === 0) {
                managementList.innerHTML = '<div class="small">Nenhum funcionário cadastrado.</div>';
            } else {
                employees.forEach((e, idx) => {
                    const d = document.createElement('div');
                    d.className = 'employee';
                    d.innerHTML = `
                <div style="width:56px;height:56px;border-radius:8px;overflow:hidden;background:#081220;flex-shrink:0">
                    ${e.image ? `<img src="${e.image}" style="width:100%;height:100%;object-fit:cover">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:${colorFromString(e.nome)}">${initials(e.nome)}</div>`}
                </div>
                <div class="meta">
                    <div style="font-weight:700">${e.nome}</div>
                    <div class="small">${e.cargo} — ${formatCurrency(e.salario)} Kz</div>
                </div>
                <div class="actions">
                    ${currentUser.role === 'superadmin' ? `<button data-man-edit="${idx}" class="btn-ghost">Editar</button><button data-man-delete="${idx}" class="btn-danger">Apagar</button>` : ''}
                </div>
            `;
                    managementList.appendChild(d);
                });
            }

            // garante que os handlers por delegação fiquem ativos (não depende de elementos já existentes)
            attachHandlers();
            countEl.textContent = employees.length + (employees.length === 1 ? ' funcionário' : ' funcionários');
        }


        // ----- Substitua a função attachHandlers inteira por esta (delegation) -----
        function attachHandlers() {
            // Remove listeners anteriores (se existirem) para evitar duplicação
            adminsListEl.onclick = null;
            employeesGrid.onclick = null;
            managementList.onclick = null;

            // Delegation para admins (editar / apagar)
            adminsListEl.addEventListener('click', (ev) => {
                const btnEdit = ev.target.closest('[data-admin-edit]');
                if (btnEdit) {
                    const idx = parseInt(btnEdit.getAttribute('data-admin-edit'), 10);
                    openModalAdminEdit(idx);
                    return;
                }
                const btnDel = ev.target.closest('[data-admin-delete]');
                if (btnDel) {
                    const idx = parseInt(btnDel.getAttribute('data-admin-delete'), 10);
                    if (confirm('Apagar este administrador?')) {
                        const id = admins[idx].id;
                        admins.splice(idx, 1);
                        employees = employees.filter(e => e.id !== id);
                        saveAll(); renderAll();
                    }
                    return;
                }
            });

            // Delegation para employees grid (editar / apagar)
            employeesGrid.addEventListener('click', (ev) => {
                const btnEdit = ev.target.closest('[data-emp-edit]');
                if (btnEdit) {
                    const idx = parseInt(btnEdit.getAttribute('data-emp-edit'), 10);
                    openModalEmpEdit(idx);
                    return;
                }
                const btnDel = ev.target.closest('[data-emp-delete]');
                if (btnDel) {
                    const idx = parseInt(btnDel.getAttribute('data-emp-delete'), 10);
                    if (confirm('Apagar este funcionário?')) {
                        const id = employees[idx].id;
                        employees.splice(idx, 1);
                        admins = admins.filter(a => a.id !== id);
                        saveAll(); renderAll();
                    }
                    return;
                }
            });

            // Delegation para management list (editar / apagar)
            managementList.addEventListener('click', (ev) => {
                const btnEdit = ev.target.closest('[data-man-edit]');
                if (btnEdit) {
                    const idx = parseInt(btnEdit.getAttribute('data-man-edit'), 10);
                    openModalEmpEdit(idx);
                    return;
                }
                const btnDel = ev.target.closest('[data-man-delete]');
                if (btnDel) {
                    const idx = parseInt(btnDel.getAttribute('data-man-delete'), 10);
                    if (confirm('Apagar este funcionário?')) {
                        const id = employees[idx].id;
                        employees.splice(idx, 1);
                        admins = admins.filter(a => a.id !== id);
                        saveAll(); renderAll();
                    }
                    return;
                }
            });
        }



        function saveAll() { localStorage.setItem(adminsKey, JSON.stringify(admins)); localStorage.setItem(empsKey, JSON.stringify(employees)); }

        // seed (apenas se vazio)
        function seedIfEmpty() {
            if (admins.length === 0 && employees.length === 0) {
                const a1 = { nome: 'Joana Silva', cargo: 'Administradora', salario: 80000, image: null, role: 'admin', id: Date.now() + 1 };
                const e1 = { nome: 'Ana Pereira', cargo: 'RH', salario: 80000, image: null, role: 'employee', id: Date.now() + 2 };
                const e2 = { nome: 'Miguel Costa', cargo: 'Financeiro', salario: 120000, image: null, role: 'employee', id: Date.now() + 3 };
                admins = [a1];
                employees = [e1, e2, { ...a1 }];
                saveAll();
            }
        }

        // keyboard + outside click to close
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { modalAdmin.style.display = 'none'; modalEmp.style.display = 'none'; }
        });
        document.querySelectorAll('.modal-backdrop').forEach(md => {
            md.addEventListener('click', (ev) => { if (ev.target === md) md.style.display = 'none'; });
        });

        // initialize
        seedIfEmpty();
        renderAll();
    </script>
</body>

</html>